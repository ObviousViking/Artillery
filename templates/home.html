{% extends "base.html" %}
{% block content %}

<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="card-title mb-3">Welcome to Artillery</h1>
        <p class="mb-3">
          Artillery is your lightweight web front-end for
          <code>gallery-dl</code>. Create repeatable download tasks, schedule
          them with cron, and keep everything isolated per task folder.
        </p>

        <ul class="mb-3">
          <li>Each task has its own folder under <code>/tasks/&lt;task-name&gt;</code>.</li>
          <li>Downloads go to <code>/downloads</code> using your global <code>gallery-dl.conf</code>.</li>
          <li>Tasks can be run manually, paused, or scheduled via cron.</li>
          <li>All output is logged to each task's <code>logs.txt</code> for troubleshooting.</li>
        </ul>

        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('tasks') }}" class="btn btn-danger">View tasks</a>
          <a href="{{ url_for('config_page') }}" class="btn btn-outline-light">Edit config</a>
        </div>
      </div>
    </div>
  </div>
</div>

{% if media_wall_enabled %}
<div class="row">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body" style="position:relative;"> <!-- made positioned so loader overlay works -->
        <h5 class="card-title mb-3">
          Media wall
          <button id="media-wall-refresh-btn" class="btn btn-sm btn-outline-light ms-2" title="Refresh media wall">Refresh</button>
        </h5>

        <!-- moved loader inside the container so it overlays the wall -->
        <div id="media-wall-container" class="media-wall-scroll-container" style="display:none;">
          <div id="media-wall-loader" class="media-wall-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p class="mt-3">Preparing media wall...</p>
          </div>

          <div id="media-wall-scroll" class="media-wall-scroll">
            <!-- Images will be populated here -->
          </div>
        </div>

        <div id="media-wall-empty" class="text-muted mb-0" {% if has_media %}style="display:none"{% endif %}>
          No media cached yet. Run a task, then refresh the media wall.
        </div>

      </div>
    </div>
  </div>
</div>
 
<style>
/* loader overlay inside the container */
.media-wall-loading {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 30;
  display: none;
  align-items: center;
  flex-direction: column;
  gap: 8px;
  background: rgba(0,0,0,0.6);
  padding: 18px;
  border-radius: 8px;
  color: #ddd;
  min-width: 220px;
  text-align: center;
}
.media-wall-loading .loading-spinner {
  width: 36px;
  height: 36px;
  border: 4px solid rgba(255,255,255,0.12);
  border-top-color: rgba(255,255,255,0.9);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ensure the container is positioned so overlay aligns */
.media-wall-scroll-container { position: relative; }

/* Media wall container - fixed height with vertical scroll */
.media-wall-scroll-container {
  width: 100%;
  height: 600px;
  overflow: hidden;
  background: transparent;
  position: relative;
}

/* expose scroll-duration for JS-driven scroll */
:root {
  --mediawall-scroll-duration-ms: 120000; /* 120s */
}

/* masonry via CSS columns to avoid grid-gap artifacts */
.media-wall-scroll {
  column-width: 220px;
  column-gap: 12px;
  width: 100%;
  will-change: transform;
}

/* Media item - thumbnail */
.media-item {
  display: inline-block;
  width: 100%;
  margin: 0 0 8px;
  overflow: hidden;
  background: transparent;
  cursor: pointer;
  transition: transform 0.2s ease;
  break-inside: avoid;
}

.media-item:hover {
  transform: scale(1.02);
  z-index: 5;
}

.media-item img {
  width: 100%;
  height: auto;
  object-fit: contain;
  display: block;
  border-radius: 8px;
  background: #222;
  box-shadow: 0 2px 8px rgba(0,0,0,0.18);
}

/* Fade at top/bottom */
.media-wall-scroll-container::before,
.media-wall-scroll-container::after {
  content: '';
  position: absolute;
  left: 0;
  width: 100%;
  height: 40px;
  z-index: 10;
  pointer-events: none;
}
.media-wall-scroll-container::before { top: 0; background: linear-gradient(to bottom, rgba(5,5,5,1), rgba(5,5,5,0)); }
.media-wall-scroll-container::after  { bottom:0; background: linear-gradient(to top, rgba(5,5,5,1), rgba(5,5,5,0)); }

</style>

<script>
(function () {
  const loader = document.getElementById("media-wall-loader");
  const emptyMsg = document.getElementById("media-wall-empty");
  const container = document.getElementById("media-wall-container");
  const scrollWrapperId = "media-wall-scroll";
  let lastSig = "";
  // use a property on window to store raf id so footer code can stop it
  window.__artillery_mediawall_raf = null;

  function showLoader() {
    if (emptyMsg) emptyMsg.style.display = "none";
    if (loader) loader.style.display = "flex";
  }
  function hideLoader() {
    if (loader) loader.style.display = "none";
  }
  function setEmpty(isEmpty, text) {
    if (!emptyMsg) return;
    emptyMsg.textContent = text || "No media cached yet. Run a task, then refresh the media wall.";
    emptyMsg.style.display = isEmpty ? "" : "none";
  }

  function createItemsDOM(items) {
    const fragment = document.createDocumentFragment();
    items.forEach(item => {
      const url = item.url || item;
      const mtime = item.mtime || 0;
      const src = url + (url.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(mtime);

      const itemDiv = document.createElement("div");
      itemDiv.className = "media-item";

      const a = document.createElement("a");
      a.href = src;
      a.target = "_blank";
      a.rel = "noopener";

      const img = document.createElement("img");
      img.src = src;
      img.alt = "media";
      img.loading = "lazy";

      a.appendChild(img);
      itemDiv.appendChild(a);
      fragment.appendChild(itemDiv);
    });
    return fragment;
  }

  function cancelWallAnimation() {
    if (window.__artillery_mediawall_raf) {
      cancelAnimationFrame(window.__artillery_mediawall_raf);
      window.__artillery_mediawall_raf = null;
    }
    const el = document.getElementById(scrollWrapperId);
    if (el) {
      el.style.transform = "";
      el._mw_running = false;
    }
  }

  // expose helpers for footer toggle to control the UI
  window.__artillery_mediawall_disable_ui = function() {
    cancelWallAnimation();
    const wall = document.getElementById(scrollWrapperId);
    if (wall && wall.parentNode) wall.parentNode.removeChild(wall);
    if (container) container.style.display = "none";
    setEmpty(true, "Media wall is disabled.");
    // disable refresh button if present
    const rb = document.getElementById('footer-refresh-btn');
    if (rb) rb.disabled = true;
  };

  window.__artillery_mediawall_enable_ui = function() {
    // enable refresh button and trigger a refresh
    const rb = document.getElementById('footer-refresh-btn');
    if (rb) rb.disabled = false;
    if (window.__artillery_mediawall_refresh) window.__artillery_mediawall_refresh();
  };

  function enableContinuousScroll(wallEl) {
    // start rAF loop and store id on window so other code can cancel
    const DURATION = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--mediawall-scroll-duration-ms')) || 120000;
    if (!localStorage.getItem('mediawall_start_ts')) {
      localStorage.setItem('mediawall_start_ts', Date.now().toString());
    }
    const startTs = () => parseInt(localStorage.getItem('mediawall_start_ts'), 10) || Date.now();

    function frame() {
      const start = startTs();
      const elapsed = (Date.now() - start) % DURATION;
      const progress = elapsed / DURATION;

      const totalHeight = wallEl.scrollHeight || 1;
      const half = Math.floor(totalHeight / 2) || 1;
      const y = -Math.round(progress * half);

      wallEl.style.transform = `translateY(${y}px)`;
      window.__artillery_mediawall_raf = requestAnimationFrame(frame);
    }

    wallEl._mw_running = true;
    frame();

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && !localStorage.getItem('mediawall_start_ts')) {
        localStorage.setItem('mediawall_start_ts', Date.now().toString());
      }
    }, { once: false });
  }

  async function refresh(triggeredByUser = false) {
    showLoader();
    try {
      const res = await fetch("/mediawall/api/list_cache", { cache: "no-store" });
      if (!res.ok) { hideLoader(); return; }
      const data = await res.json();
      const items = (data.items || []);

      if (!items.length) {
        setEmpty(true);
        hideLoader();
        if (container) container.style.display = "none";
        return;
      }

      const sig = items.map(i => (i.name || i.url) + ":" + (i.mtime || "")).join("|");
      if (!triggeredByUser && sig && sig === lastSig) {
        hideLoader();
        return;
      }
      lastSig = sig;

      const preload = [];
      for (let i = 0; i < Math.min(6, items.length); i++) {
        preload.push(new Promise(res => {
          const p = new Image();
          const url = items[i].url || items[i];
          const mtime = items[i].mtime || 0;
          const src = url + (url.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(mtime);
          p.onload = () => res();
          p.onerror = () => res();
          p.src = src;
        }));
      }
      await Promise.all(preload);

      const newWall = document.createElement("div");
      newWall.id = scrollWrapperId;
      newWall.className = "media-wall-scroll";

      const frag1 = createItemsDOM(items);
      const frag2 = frag1.cloneNode(true);
      newWall.appendChild(frag1);
      newWall.appendChild(frag2);

      const old = document.getElementById(scrollWrapperId);
      if (old && old.parentNode) {
        cancelWallAnimation();
        old.parentNode.replaceChild(newWall, old);
      } else if (container) {
        container.querySelector('.media-wall-scroll')?.remove();
        container.appendChild(newWall);
      }

      enableContinuousScroll(newWall);

      setEmpty(false);
      container.style.display = "";
      hideLoader();
    } catch (e) {
      hideLoader();
      console.error("media wall refresh error:", e);
    }
  }

  // wire up initial behavior and SSE
  document.addEventListener("DOMContentLoaded", () => {
    const autoKey = 'mediawall_auto_refreshed';
    if (!localStorage.getItem(autoKey)) {
      refresh();
      localStorage.setItem(autoKey, '1');
    } else {
      refresh(false);
    }

    if (window.EventSource) {
      try {
        const es = new EventSource('/mediawall/events');
        es.addEventListener('mediawall_update', () => { refresh(); });
      } catch (e) { /* ignore */ }
    }

    // Wire the new refresh button
    const refreshBtn = document.getElementById('media-wall-refresh-btn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', async function () {
        refreshBtn.disabled = true;
        try {
          await fetch('/mediawall/refresh', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        } catch (e) {}
        if (window.__artillery_mediawall_refresh) {
          window.__artillery_mediawall_refresh();
        }
        refreshBtn.disabled = false;
      });
    }
  });

  // expose a client-triggered refresh (used by footer)
  window.__artillery_mediawall_refresh = () => refresh(true);

})();
</script>

{% endif %}

<!-- Footer bar -->
<footer class="footer-bar">
  <div class="footer-content">
    <div style="display:flex;align-items:center;gap:12px;">
      <a href="https://github.com/ObviousViking/Artillery" target="_blank" rel="noopener" class="footer-link">
        Artillery on GitHub
      </a>
      <button id="footer-refresh-btn" class="btn btn-sm btn-outline-light">Refresh wall</button>
    </div>

    <div style="display:flex;align-items:center;gap:12px;">
      <label class="toggle-switch" title="Enable media wall">
        <input type="checkbox" id="footer-media-toggle" {% if media_wall_enabled %}checked{% endif %}>
        <span class="slider"></span>
      </label>
      <!-- interval moved to config page per request; footer only has toggle + refresh -->
    </div>
  </div>
</footer>

<style>
/* toggle switch */
.toggle-switch { position: relative; display:inline-block; width:46px; height:24px; }
.toggle-switch input { display:none; }
.slider { position:absolute; cursor:pointer; inset:0; background:#444; border-radius:24px; transition:0.2s; }
.slider:before { content:''; position:absolute; left:3px; top:3px; width:18px; height:18px; background:#fff; border-radius:50%; transition:0.2s; }
.toggle-switch input:checked + .slider  { background:#0d6efd; }
.toggle-switch input:checked + .slider:before { transform: translateX(22px); }

/* footer layout */
.footer-bar { width:100%; background:#181a1b; color:#bbb; padding:12px 0; position:fixed; left:0; bottom:0; z-index:100; border-top:1px solid #232323; box-shadow:0 -2px 8px rgba(0,0,0,0.12); }
.footer-content { max-width: 1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:0 24px; gap:12px; }
.footer-link { color:#bbb; text-decoration:none; font-weight:500; }
.footer-link:hover { color:#fff; text-decoration:underline; }
body { padding-bottom:84px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const toggle = document.getElementById('footer-media-toggle');
  const refreshBtn = document.getElementById('footer-refresh-btn');

  async function ajaxPostJson(url, obj) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify(obj || {})
    });
    return res.json();
  }

  if (toggle) {
    toggle.addEventListener('change', async function () {
      try {
        const data = await ajaxPostJson('/mediawall/toggle', {});
        if (!data || data.success === false) throw new Error(data && data.error ? data.error : 'toggle failed');

        if (data.media_wall_enabled === false) {
          // immediate UI disable
          if (window.__artillery_mediawall_disable_ui) window.__artillery_mediawall_disable_ui();
        } else {
          // enable UI and refresh
          if (window.__artillery_mediawall_enable_ui) window.__artillery_mediawall_enable_ui();
        }
      } catch (e) {
        console.error('toggle failed', e);
        toggle.checked = !toggle.checked;
      }
    });
  }

  if (refreshBtn) {
    refreshBtn.addEventListener('click', async function () {
      refreshBtn.disabled = true;
      try { await ajaxPostJson('/mediawall/refresh', {}); } catch (e) {}
      if (window.__artillery_mediawall_refresh) window.__artillery_mediawall_refresh();
      refreshBtn.disabled = false;
    });
  }
});
</script>

{% endblock %}