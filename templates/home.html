{% extends "base.html" %}
{% block content %}

<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="card-title mb-3">Welcome to Artillery</h1>
        <p class="mb-3">
          Artillery is your lightweight web front-end for
          <code>gallery-dl</code>. Create repeatable download tasks, schedule
          them with cron, and keep everything isolated per task folder.
        </p>

        <ul class="mb-3">
          <li>Each task has its own folder under <code>/tasks/&lt;task-name&gt;</code>.</li>
          <li>Downloads go to <code>/downloads</code> using your global <code>gallery-dl.conf</code>.</li>
          <li>Tasks can be run manually, paused, or scheduled via cron.</li>
          <li>All output is logged to each taskâ€™s <code>logs.txt</code> for troubleshooting.</li>
        </ul>

        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('tasks') }}" class="btn btn-danger">View tasks</a>
          <a href="{{ url_for('config_page') }}" class="btn btn-outline-light">Edit config</a>
        </div>
      </div>
    </div>
  </div>
</div>

{% if media_wall_enabled %}
<!-- Media wall -->
<div class="row">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Media wall</h5>

        <div id="media-wall-container"
             data-rows="3"
             data-limit="150"
             data-poll-ms="3000">

          <p id="media-wall-loader" class="text-muted small mb-2">
            Loading media wall...
          </p>

          <p id="media-wall-empty" class="text-muted mb-0" {% if has_media %}style="display:none"{% endif %}>
            No media cached yet. Run a task, then refresh the media wall.
          </p>

          <!-- initial server-render (fast first paint) -->
          <div class="media-wall {% if has_media %}media-wall-ready{% endif %}" id="media-wall">
            {% if has_media %}
              {% for row in recent_rows %}
                {% if row %}
                <div class="media-wall-row">
                  <div class="media-strip
                    {% if loop.index0 == 1 %}
                      media-strip-right
                    {% else %}
                      media-strip-left
                    {% endif %}">
                    {# duplicate items to allow continuous scroll #}
                    {% for _ in range(2) %}
                      {% for item in row %}
                        <div class="media-item">
                          <a href="{{ item }}" target="_blank" class="d-block">
                            <img src="{{ item }}" alt="media" class="media-img" loading="lazy" />
                          </a>
                        </div>
                      {% endfor %}
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
              {% endfor %}
            {% endif %}
          </div>
        </div>

        <script>
        (function () {
          const container = document.getElementById("media-wall-container");
          if (!container) return;

          const rows = parseInt(container.dataset.rows || "3", 10);
          const limit = parseInt(container.dataset.limit || "150", 10);
          const pollMs = parseInt(container.dataset.pollMs || "3000", 10);

          const loader = document.getElementById("media-wall-loader");
          const emptyMsg = document.getElementById("media-wall-empty");
          const wall = document.getElementById("media-wall");

          let lastSig = "";

          function hideLoader() { if (loader) loader.style.display = "none"; }
          function setEmpty(isEmpty) { if (emptyMsg) emptyMsg.style.display = isEmpty ? "" : "none"; }
          function setReady() { if (wall) wall.classList.add("media-wall-ready"); }
          function buildUrl(baseUrl, v) { return baseUrl + (baseUrl.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(v); }

          // --- Seamless loop: SUB-PIXEL accurate distance to start of copy #2 ---
          let _marqueeTimer = null;

          function scheduleInitMarquees() {
            clearTimeout(_marqueeTimer);
            _marqueeTimer = setTimeout(initMarquees, 50);
          }

          function initMarquees() {
            const strips = document.querySelectorAll(".media-strip");
            strips.forEach(strip => {
              const kids = strip.children;
              if (!kids || kids.length < 2) return;

              const half = Math.floor(kids.length / 2);
              if (!kids[half]) return;

              const stripRect = strip.getBoundingClientRect();
              const kidRect = kids[half].getBoundingClientRect();
              const distance = kidRect.left - stripRect.left;

              if (!(distance > 0)) return;

              const speed = 16; // px/sec
              const duration = Math.max(25, distance / speed);

              const prev = strip.__loopDistance || 0;
              const prevDur = strip.__loopDuration || 0;
              if (Math.abs(prev - distance) < 0.1 && Math.abs(prevDur - duration) < 0.05) return;

              strip.__loopDistance = distance;
              strip.__loopDuration = duration;

              strip.style.setProperty("--loop-distance", distance.toFixed(2) + "px");
              strip.style.setProperty("--duration", duration.toFixed(2) + "s");
            });
          }
          // ---------------------------------------------------------------------

          function render(items) {
            if (!wall) return;

            wall.innerHTML = "";

            if (!items.length) {
              setEmpty(true);
              hideLoader();
              setReady();
              return;
            }

            setEmpty(false);

            // playlist size per row (before duplicating)
            const perRow = Math.min(80, Math.max(30, items.length));

            // ---- Shared pool across all rows to reduce duplicates ----
            let pool = items.slice();
            for (let i = pool.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            let poolIdx = 0;

            const usedGlobal = new Set();

            function reshufflePool() {
              for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
              }
            }

            function nextFromPool() {
              if (!pool.length) return null;
              const it = pool[poolIdx++];
              if (poolIdx >= pool.length) {
                poolIdx = 0;
                reshufflePool();
              }
              return it;
            }

            function buildPlaylist(count) {
              const out = [];
              let guard = 0;

              // Pass 1: avoid duplicates across rows this render
              while (out.length < count && guard < count * 10) {
                guard++;
                const it = nextFromPool();
                if (!it) break;

                const key = it.name || it.url;
                if (usedGlobal.has(key)) continue;

                usedGlobal.add(key);
                out.push(it);
              }

              // Pass 2: allow repeats if we ran out of uniques
              while (out.length < count) {
                const it = nextFromPool();
                if (!it) break;
                out.push(it);
              }

              return out;
            }
            // ---------------------------------------------------------

            for (let rowIdx = 0; rowIdx < rows; rowIdx++) {
              const rowItems = buildPlaylist(perRow);
              if (!rowItems.length) continue;

              const rowDiv = document.createElement("div");
              rowDiv.className = "media-wall-row";

              const strip = document.createElement("div");
              strip.className = "media-strip " + (rowIdx === 1 ? "media-strip-right" : "media-strip-left");

              // duplicate once to enable seamless loop
              for (let r = 0; r < 2; r++) {
                for (const it of rowItems) {
                  const itemDiv = document.createElement("div");
                  itemDiv.className = "media-item";

                  const a = document.createElement("a");
                  a.className = "d-block";
                  a.target = "_blank";
                  a.href = buildUrl(it.url, it.mtime);

                  const img = document.createElement("img");
                  img.className = "media-img";
                  img.loading = "lazy";
                  img.alt = "media";

                  const setSrc = (v) => { img.src = buildUrl(it.url, v); };
                  setSrc(it.mtime);

                  img.onerror = () => setTimeout(() => setSrc(Date.now()), 800);

                  a.appendChild(img);
                  itemDiv.appendChild(a);
                  strip.appendChild(itemDiv);
                }
              }

              rowDiv.appendChild(strip);
              wall.appendChild(rowDiv);
            }

            hideLoader();
            setReady();

            // Recalc once now, then again as images load/layout settles
            scheduleInitMarquees();
            setTimeout(scheduleInitMarquees, 250);
            setTimeout(scheduleInitMarquees, 1000);

            // Recalc when images load (subpixel widths can change after load)
            wall.querySelectorAll("img.media-img").forEach(img => {
              if (img.complete) return;
              img.addEventListener("load", scheduleInitMarquees, { once: true });
            });
          }

          async function refresh() {
            try {
              const res = await fetch("/mediawall/api/cache_index", { cache: "no-store" });
              if (!res.ok) return;

              const data = await res.json();
              const items = (data.items || []).slice(0, limit);

              const sig = items.map(i => i.name + ":" + i.mtime).join("|");
              if (sig && sig === lastSig) {
                hideLoader();
                setReady();
                return;
              }
              lastSig = sig;

              render(items);
            } catch (e) {
              // keep polling quietly
            }
          }

          document.addEventListener("DOMContentLoaded", () => {
            // initialize scrolling for server-rendered content (if present)
            scheduleInitMarquees();
            setTimeout(scheduleInitMarquees, 250);
            setTimeout(scheduleInitMarquees, 1000);

            window.addEventListener("resize", () => setTimeout(scheduleInitMarquees, 150));

            // build randomized strips from API + keep updated
            refresh();
            setInterval(refresh, pollMs);
          });
        })();
        </script>

      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
