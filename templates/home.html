{% extends "base.html" %}
{% block content %}

<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="card-title mb-3">Welcome to Artillery</h1>
        <p class="mb-3">
          Artillery is your lightweight web front-end for
          <code>gallery-dl</code>. Create repeatable download tasks, schedule
          them with cron, and keep everything isolated per task folder.
        </p>

        <ul class="mb-3">
          <li>Each task has its own folder under <code>/tasks/&lt;task-name&gt;</code>.</li>
          <li>Downloads go to <code>/downloads</code> using your global <code>gallery-dl.conf</code>.</li>
          <li>Tasks can be run manually, paused, or scheduled via cron.</li>
          <li>All output is logged to each task's <code>logs.txt</code> for troubleshooting.</li>
        </ul>

        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('tasks') }}" class="btn btn-danger">View tasks</a>
          <a href="{{ url_for('config_page') }}" class="btn btn-outline-light">Edit config</a>
        </div>
      </div>
    </div>
  </div>
</div>

{% if media_wall_enabled %}
<!-- Media wall with Swiper -->
<div class="row">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Media wall</h5>

        <div id="media-wall-loader" class="text-muted small mb-2" style="display:none;">
          Loading media wall...
        </div>

        <div id="media-wall-empty" class="text-muted mb-0" {% if has_media %}style="display:none"{% endif %}>
          No media cached yet. Run a task, then refresh the media wall.
        </div>

        <!-- Swiper carousel -->
        <div class="swiper" id="media-swiper" style="display:none;">
          <div class="swiper-wrapper" id="media-swiper-wrapper">
            <!-- slides populated by JS -->
          </div>
          <!-- Navigation -->
          <div class="swiper-button-next"></div>
          <div class="swiper-button-prev"></div>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
  #media-swiper {
    width: 100%;
    height: 400px;
  }
  .swiper-slide {
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }
  .swiper-slide img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
</style>

<script>
(function () {
  const loader = document.getElementById("media-wall-loader");
  const emptyMsg = document.getElementById("media-wall-empty");
  const swiperEl = document.getElementById("media-swiper");
  const wrapper = document.getElementById("media-swiper-wrapper");

  let swiper = null;
  let lastSig = "";

  function showLoader() { if (loader) loader.style.display = ""; }
  function hideLoader() { if (loader) loader.style.display = "none"; }
  function setEmpty(isEmpty) { if (emptyMsg) emptyMsg.style.display = isEmpty ? "" : "none"; }

  async function refresh() {
    showLoader();
    try {
      const res = await fetch("/mediawall/api/list_cache", { cache: "no-store" });
      if (!res.ok) return;

      const data = await res.json();
      const items = (data.items || []);

      if (!items.length) {
        setEmpty(true);
        hideLoader();
        if (swiperEl) swiperEl.style.display = "none";
        return;
      }

      const sig = items.map(i => (i.name || i.url) + ":" + (i.mtime || "")).join("|");
      if (sig && sig === lastSig) {
        hideLoader();
        return;
      }
      lastSig = sig;

      // build slides
      wrapper.innerHTML = "";
      items.forEach(item => {
        const url = item.url || item;
        const mtime = item.mtime || 0;
        const src = url + (url.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(mtime);

        const slide = document.createElement("div");
        slide.className = "swiper-slide";

        const img = document.createElement("img");
        img.src = src;
        img.alt = "media";
        img.loading = "lazy";

        const a = document.createElement("a");
        a.href = src;
        a.target = "_blank";
        a.style.display = "contents";
        a.appendChild(img);

        slide.appendChild(a);
        wrapper.appendChild(slide);
      });

      setEmpty(false);
      swiperEl.style.display = "";

      // init or reinit swiper
      if (!swiper) {
        swiper = new Swiper("#media-swiper", {
          loop: true,
          autoplay: { delay: 5000, disableOnInteraction: false },
          navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev"
          },
          lazy: { loadPrevNext: true, loadPrevNextAmount: 2 }
        });
      } else {
        swiper.update();
      }

      hideLoader();
    } catch (e) {
      hideLoader();
      console.error("media wall refresh error:", e);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // initial load
    refresh();

    // poll periodically
    setInterval(refresh, 15000);

    // SSE listener for immediate updates
    if (window.EventSource) {
      try {
        const es = new EventSource('/mediawall/events');
        es.addEventListener('mediawall_update', () => { refresh(); });
        es.addEventListener('error', () => { /* fallback poll still running */ });
      } catch (e) { /* ignore */ }
    }
  });
})();
</script>

{% endif %}

{% endblock %}
