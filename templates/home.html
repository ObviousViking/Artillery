{% extends "base.html" %}
{% block content %}

<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="card-title mb-3">Welcome to Artillery</h1>
        <p class="mb-3">
          Artillery is your lightweight web front-end for
          <code>gallery-dl</code>. Create repeatable download tasks, schedule
          them with cron, and keep everything isolated per task folder.
        </p>

        <ul class="mb-3">
          <li>Each task has its own folder under <code>/tasks/&lt;task-name&gt;</code>.</li>
          <li>Downloads go to <code>/downloads</code> using your global <code>gallery-dl.conf</code>.</li>
          <li>Tasks can be run manually, paused, or scheduled via cron.</li>
          <li>All output is logged to each task's <code>logs.txt</code> for troubleshooting.</li>
        </ul>

        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('tasks') }}" class="btn btn-danger">View tasks</a>
          <a href="{{ url_for('config_page') }}" class="btn btn-outline-light">Edit config</a>
        </div>
      </div>
    </div>
  </div>
</div>

{% if media_wall_enabled %}
<!-- Media wall - vertical infinite scroll grid -->
<div class="row">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Media wall</h5>

        <div id="media-wall-loader" class="media-wall-loading" style="display: none;">
          <div class="loading-spinner"></div>
          <p class="mt-3">Scanning logs and preparing media wall...</p>
        </div>

        <div id="media-wall-empty" class="text-muted mb-0" {% if has_media %}style="display:none"{% endif %}>
          No media cached yet. Run a task, then refresh the media wall.
        </div>

        <!-- Vertical scroll container -->
        <div id="media-wall-container" class="media-wall-scroll-container" style="display:none;">
          <div id="media-wall-scroll" class="media-wall-scroll">
            <!-- Images will be populated here -->
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
  /* Media wall container - fixed height with vertical scroll */
  .media-wall-scroll-container {
    width: 100%;
    height: 600px;
    overflow: hidden;
    background: transparent;
    position: relative;
  }

  /* Vertical scroll strip - grid layout */
  .media-wall-scroll {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0;
    padding: 0;
    width: 100%;
    animation: scroll-up 120s linear infinite;
    will-change: transform;
  }

  /* Seamless vertical scrolling - scrolls up continuously */
  @keyframes scroll-up {
    0% { transform: translateY(0); }
    100% { transform: translateY(calc(-50%)); }
  }

  /* Media item - thumbnail */
  .media-item {
    width: 100%;
    height: 150px;
    overflow: hidden;
    background: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .media-item:hover {
    transform: scale(1.05);
    z-index: 5;
  }

  .media-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: transparent;
  }

  /* Fade effect at top and bottom of viewport */
  .media-wall-scroll-container::before,
  .media-wall-scroll-container::after {
    content: '';
    position: absolute;
    left: 0;
    width: 100%;
    height: 40px;
    z-index: 10;
    pointer-events: none;
  }

  .media-wall-scroll-container::before {
    top: 0;
    background: linear-gradient(to bottom, rgba(5,5,5,1), rgba(5,5,5,0));
  }

  .media-wall-scroll-container::after {
    bottom: 0;
    background: linear-gradient(to top, rgba(5,5,5,1), rgba(5,5,5,0));
  }
</style>

<script>
(function () {
  const loader = document.getElementById("media-wall-loader");
  const emptyMsg = document.getElementById("media-wall-empty");
  const container = document.getElementById("media-wall-container");
  const scrollWall = document.getElementById("media-wall-scroll");

  let lastSig = "";

  function showLoader() { if (loader) loader.style.display = "flex"; }
  function hideLoader() { if (loader) loader.style.display = "none"; }
  function setEmpty(isEmpty) { if (emptyMsg) emptyMsg.style.display = isEmpty ? "" : "none"; }

  function createItemsDOM(items) {
    const fragment = document.createDocumentFragment();
    items.forEach(item => {
      const url = item.url || item;
      const mtime = item.mtime || 0;
      const src = url + (url.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(mtime);

      const itemDiv = document.createElement("div");
      itemDiv.className = "media-item";

      const img = document.createElement("img");
      img.src = src;
      img.alt = "media";
      img.loading = "lazy";

      const a = document.createElement("a");
      a.href = src;
      a.target = "_blank";
      a.style.display = "contents";
      a.appendChild(img);

      itemDiv.appendChild(a);
      fragment.appendChild(itemDiv);
    });
    return fragment;
  }

  async function refresh() {
    showLoader();
    try {
      const res = await fetch("/mediawall/api/list_cache", { cache: "no-store" });
      if (!res.ok) return;

      const data = await res.json();
      const items = (data.items || []);

      if (!items.length) {
        setEmpty(true);
        hideLoader();
        if (container) container.style.display = "none";
        return;
      }

      const sig = items.map(i => (i.name || i.url) + ":" + (i.mtime || "")).join("|");
      if (sig && sig === lastSig) {
        hideLoader();
        return;
      }
      lastSig = sig;

      // Preload a small sample to ensure smooth transition
      const preloadImgs = [];
      for (let i = 0; i < Math.min(5, items.length); i++) {
        preloadImgs.push(new Promise(resolve => {
          const p = new Image();
          const url = items[i].url || items[i];
          const mtime = items[i].mtime || 0;
          const src = url + (url.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(mtime);
          p.onload = () => resolve();
          p.onerror = () => resolve();
          p.src = src;
        }));
      }

      Promise.all(preloadImgs).then(() => {
        // Populate the scroll wall
        // Duplicate items to ensure seamless infinite scroll (2x for 50% halfway point)
        const newWall = document.createElement("div");
        newWall.className = "media-wall-scroll";
        
        // Add items twice to enable seamless 50% halfway-point loop
        newWall.appendChild(createItemsDOM(items).cloneNode(true));
        newWall.appendChild(createItemsDOM(items).cloneNode(true));

        if (scrollWall && scrollWall.parentNode) {
          const parent = scrollWall.parentNode;
          parent.style.animationPlayState = "paused";
          scrollWall.parentNode.replaceChild(newWall, scrollWall);
          document.getElementById("media-wall-scroll").parentNode.replaceChild(newWall, document.getElementById("media-wall-scroll"));
          
          setTimeout(() => {
            parent.style.animationPlayState = "running";
          }, 50);
        }

        setEmpty(false);
        container.style.display = "";
        hideLoader();
      }).catch(() => {
        // fallback: direct swap without preload
        const newWall = document.createElement("div");
        newWall.className = "media-wall-scroll";
        newWall.appendChild(createItemsDOM(items).cloneNode(true));
        newWall.appendChild(createItemsDOM(items).cloneNode(true));
        
        if (scrollWall && scrollWall.parentNode) {
          scrollWall.parentNode.replaceChild(newWall, scrollWall);
        }

        setEmpty(false);
        container.style.display = "";
        hideLoader();
      });
    } catch (e) {
      hideLoader();
      console.error("media wall refresh error:", e);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    refresh();
    // Removed auto-refresh setInterval - rely on EventSource (SSE) for updates
    // Only refresh when explicitly triggered via SSE or manual action
    if (window.EventSource) {
      try {
        const es = new EventSource('/mediawall/events');
        es.addEventListener('mediawall_update', () => { refresh(); });
        es.addEventListener('error', () => { /* SSE connection lost, will retry */ });
      } catch (e) { /* ignore */ }
    }
  });
})();
</script>

{% endif %}

{% endblock %}
