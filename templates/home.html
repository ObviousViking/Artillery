{% extends "base.html" %}
{% block content %}

<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="card-title mb-3">Welcome to Artillery</h1>
        <p class="mb-3">
          Artillery is your lightweight web front-end for
          <code>gallery-dl</code>. Create repeatable download tasks, schedule
          them with cron, and keep everything isolated per task folder.

          --dev--
        </p>

        <ul class="mb-3">
          <li>Each task has its own folder under <code>/tasks/&lt;task-name&gt;</code>.</li>
          <li>Downloads go to <code>/downloads</code> using your global <code>gallery-dl.conf</code>.</li>
          <li>Tasks can be run manually, paused, or scheduled via cron.</li>
          <li>All output is logged to each task's <code>logs.txt</code> for troubleshooting.</li>
        </ul>

        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('tasks') }}" class="btn btn-danger">View tasks</a>
          <a href="{{ url_for('config_page') }}" class="btn btn-outline-light">Edit config</a>
        </div>
      </div>
    </div>
  </div>
</div>

{% if media_wall_enabled %}
<!-- Media wall with infinite vertical scroll -->
<div class="row">
  <div class="col-12">
    <div class="card shadow-sm"
         data-media-wall-poll-interval="{{ media_wall_poll_interval|default(60) }}"
         data-media-wall-sse="{{ '1' if media_wall_sse_enabled else '0' }}">
      <div class="card-body">

        <div id="media-wall-loader" class="media-wall-loader">
          <div class="spinner-border text-light" role="status"></div>
          <span class="ms-2">Refreshing media wall...</span>
        </div>

        <div id="media-wall-empty" class="text-muted mb-0" {% if has_media %}style="display:none"{% endif %}>
          No media cached yet. Run a task, then refresh the media wall.
        </div>

        <!-- Infinite scroll container -->
        <div id="media-wall-container" class="media-wall-vertical" style="display:none;"></div>

      </div>
    </div>
  </div>
</div>

<footer class="media-wall-footer">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
    <div>
      <div class="fw-semibold">Media wall scale</div>
    </div>
    <div class="d-flex align-items-center gap-3">
      <span class="text-muted small">Large</span>
      <input id="media-wall-scale-range" class="form-range media-wall-scale-range" type="range" min="1" max="6" step="1" />
      <span class="text-muted small">Compact</span>
    </div>
  </div>
</footer>

<style>
  .media-wall-vertical {
    display: flex;
    gap: 0;
    width: 100%;
    --media-scroll-duration: 320s;
    --thumb-height: 90px;
  }

  .media-column {
    flex: 1 1 0;
    height: 600px;
    overflow: hidden;
    position: relative;
  }

  .media-strip-vertical {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding: 0;
    will-change: transform;
    min-height: 120%;
    animation: scroll-up var(--media-scroll-duration) linear infinite !important;
    animation-play-state: running !important;
  }

  @keyframes scroll-up {
    0% { transform: translateY(0); }
    100% { transform: translateY(-50%); }
  }

  .media-strip-vertical,
  .media-strip-vertical * {
    animation-duration: var(--media-scroll-duration, 160s);
  }

  .media-item {
    width: 100%;
    height: var(--thumb-height);
    overflow: hidden;
    border-radius: 0;
    background: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .media-item img {
    width: auto;
    height: 100%;
    max-width: 100%;
    object-fit: contain;
    background: transparent;
  }

  /* Patchwork sizing: vary item heights while preserving aspect ratio */
  .media-strip-vertical .media-item { height: auto; }

  .media-wall-loader {
    display: none;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .media-wall-footer {
    background: #060606;
    border-top: 1px solid #111827;
    padding: 0.85rem 1rem;
    border-radius: 0.5rem;
    margin-top: 1rem;
  }

  .media-wall-scale-range {
    width: min(320px, 70vw);
  }
</style>

<script>
(function () {
  const loader = document.getElementById("media-wall-loader");
  const emptyMsg = document.getElementById("media-wall-empty");
  const container = document.getElementById("media-wall-container");
  const scaleRange = document.getElementById("media-wall-scale-range");
  const scaleLabel = document.getElementById("media-wall-scale-label");

  let lastSig = "";
  let rowCount = 4;
  let refreshTimer = null;
  let es = null;
  let isVisible = !document.hidden;
  const scaleStorageKey = "mediaWallScale";

  function getScaleValue() {
    const raw = scaleRange?.value || "4";
    const value = Math.max(1, Math.min(6, parseInt(raw, 10) || 4));
    return value;
  }

  function thumbHeightForScale(scale) {
    switch (scale) {
      case 1: return 260;
      case 2: return 200;
      case 3: return 150;
      case 4: return 110;
      case 5: return 90;
      case 6: return 75;
      default: return 110;
    }
  }

  function buildColumns(scale) {
    if (!container) return;
    container.innerHTML = "";
    for (let i = 0; i < scale; i++) {
      const col = document.createElement("div");
      col.className = "media-column";
      const strip = document.createElement("div");
      strip.className = "media-strip-vertical";
      strip.id = `strip-${i}`;
      col.appendChild(strip);
      container.appendChild(col);
    }
  }

  function applyScale(scale) {
    rowCount = scale;
    if (container) {
      container.style.setProperty("--thumb-height", `${thumbHeightForScale(scale)}px`);
    }
    if (scaleLabel) {
      scaleLabel.textContent = `${scale} ${scale === 1 ? "column" : "columns"}`;
    }
    buildColumns(scale);
  }

  function showLoader() { if (loader) loader.style.display = "flex"; }
  function hideLoader() { if (loader) loader.style.display = "none"; }
  function setEmpty(isEmpty) { if (emptyMsg) emptyMsg.style.display = isEmpty ? "" : "none"; }

  function createItemsDOM(rowItems) {
    const fragment = document.createDocumentFragment();
    rowItems.forEach(item => {
      const url = item.url || item;
      const mtime = item.mtime || 0;
      const src = url + (url.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(mtime);

      const itemDiv = document.createElement("div");
      itemDiv.className = "media-item";

      const img = document.createElement("img");
      img.src = src;
      img.alt = "media";
      img.loading = "lazy";

      const a = document.createElement("a");
      a.href = src;
      a.target = "_blank";
      a.appendChild(img);

      itemDiv.appendChild(a);
      fragment.appendChild(itemDiv);
    });
    return fragment;
  }

  async function refresh() {
    if (!isVisible) {
      return;
    }
    showLoader();
    try {
      const res = await fetch("/mediawall/api/list_cache", { cache: "no-store" });
      if (!res.ok) return;

      const data = await res.json();
      const items = (data.items || []);

      if (!items.length) {
        setEmpty(true);
        hideLoader();
        if (container) container.style.display = "none";
        return;
      }

      const sig = items.map(i => (i.name || i.url) + ":" + (i.mtime || "")).join("|");
      if (sig && sig === lastSig) {
        hideLoader();
        return;
      }
      lastSig = sig;

      // Distribute images across N columns evenly
      const rows = Array.from({ length: rowCount }, () => []);
      items.forEach((item, idx) => {
        rows[idx % rowCount].push(item);
      });

      // preload a small sample to ensure smooth transition
      const preloadImgs = [];
      rows.forEach(rowItems => {
        for (let i = 0; i < Math.min(2, rowItems.length); i++) {
          preloadImgs.push(new Promise(resolve => {
            const p = new Image();
            const url = rowItems[i].url || rowItems[i];
            const mtime = rowItems[i].mtime || 0;
            const src = url + (url.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(mtime);
            p.onload = () => resolve();
            p.onerror = () => resolve();
            p.src = src;
          }));
        }
      });

      Promise.all(preloadImgs).then(() => {
        for (let r = 0; r < rowCount; r++) {
          const oldStrip = document.getElementById(`strip-${r}`);
          const newStrip = document.createElement("div");
          newStrip.className = "media-strip-vertical";
          newStrip.id = `strip-${r}`;

          for (let dup = 0; dup < 4; dup++) {
            newStrip.appendChild(createItemsDOM(rows[r]).cloneNode(true));
          }

          if (oldStrip && oldStrip.parentNode) {
            oldStrip.parentNode.replaceChild(newStrip, oldStrip);
          }
        }

        setEmpty(false);
        container.style.display = "";
        hideLoader();
      }).catch(() => {
        for (let r = 0; r < rowCount; r++) {
          const oldStrip = document.getElementById(`strip-${r}`);
          const newStrip = document.createElement("div");
          newStrip.className = "media-strip-vertical";
          newStrip.id = `strip-${r}`;
          for (let dup = 0; dup < 4; dup++) {
            newStrip.appendChild(createItemsDOM(rows[r]).cloneNode(true));
          }
          if (oldStrip && oldStrip.parentNode) {
            oldStrip.parentNode.replaceChild(newStrip, oldStrip);
          }
        }
        setEmpty(false);
        container.style.display = "";
        hideLoader();
      });
    } catch (e) {
      hideLoader();
      console.error("media wall refresh error:", e);
    }
  }

  function stopMediaWall() {
    if (refreshTimer) {
      clearInterval(refreshTimer);
      refreshTimer = null;
    }
    if (es) {
      try { es.close(); } catch (e) { /* ignore */ }
      es = null;
    }
  }

  document.addEventListener("visibilitychange", () => {
    isVisible = !document.hidden;
    if (isVisible) {
      refresh();
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    if (scaleRange) {
      const savedScale = parseInt(localStorage.getItem(scaleStorageKey) || "4", 10);
      const scale = Math.max(1, Math.min(6, savedScale || 4));
      scaleRange.value = String(scale);
      applyScale(scale);
      scaleRange.addEventListener("input", () => {
        const nextScale = getScaleValue();
        localStorage.setItem(scaleStorageKey, String(nextScale));
        applyScale(nextScale);
        lastSig = "";
        refresh();
      });
    } else {
      applyScale(rowCount);
    }

    refresh();

    const card = container?.closest(".card");
    const pollIntervalAttr = card?.getAttribute("data-media-wall-poll-interval");
    const sseEnabledAttr = card?.getAttribute("data-media-wall-sse") === "1";
    const pollIntervalSec = Math.max(1, parseInt(pollIntervalAttr || "60", 10));
    refreshTimer = setInterval(refresh, pollIntervalSec * 1000);

    if (sseEnabledAttr && window.EventSource) {
      try {
        es = new EventSource('/mediawall/events');
        es.addEventListener('mediawall_update', () => { refresh(); });
        es.addEventListener('error', () => { /* fallback poll running */ });
      } catch (e) { /* ignore */ }
    }

    window.addEventListener("pagehide", stopMediaWall);
    window.addEventListener("beforeunload", stopMediaWall);
  });
})();
</script>

{% endif %}

{% endblock %}
